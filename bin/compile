#!/bin/bash

set -euo pipefail

function arrow() {
  sed -u 's/^/-----> /'
}

function indent() {
  sed -u 's/^/       /'
}

BASE_DIR=$PWD
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

BUILD_PACK_PATH=$(cd $(dirname $(dirname $0)); pwd)

GEOLITE2_CITY_FILENAME="GeoLite2-City.mmdb"
GEOLITE2_CITY_TARBALL_FILENAME="GeoLite2-City.tar.gz"
GEOLITE2_COUNTRY_FILENAME="GeoLite2-Country.mmdb"
GEOLITE2_COUNTRY_TARBALL_FILENAME="GeoLite2-Country.tar.gz"

BUILD_DIST_DIR="$HOME/.geoip"
BUILD_DIST_SHARE_DIR="$BUILD_DIST_DIR/share"

GEOIP_CACHE_DIR="$CACHE_DIR/geoip"

echo "Installing GeoLite2 data from https://www.maxmind.com" | arrow

mkdir -p "$BUILD_DIST_DIR"
mkdir -p "$BUILD_DIST_SHARE_DIR"
mkdir -p "$GEOIP_CACHE_DIR"

echo "Downloading GeoLite2 City and Country data" | indent

wget -Nq -P "$GEOIP_CACHE_DIR" "https://geolite.maxmind.com/download/geoip/database/$GEOLITE2_CITY_TARBALL_FILENAME"
wget -Nq -P "$GEOIP_CACHE_DIR" "https://geolite.maxmind.com/download/geoip/database/$GEOLITE2_COUNTRY_TARBALL_FILENAME"

echo "Untarring $GEOLITE2_CITY_TARBALL_FILENAME" | indent
tar -xvf "$GEOIP_CACHE_DIR/$GEOLITE2_CITY_TARBALL_FILENAME" --directory "$BUILD_DIST_SHARE_DIR" --no-anchored --strip-components=1 "$GEOLITE2_CITY_FILENAME"
echo "Untarring $GEOLITE2_COUNTRY_TARBALL_FILENAME" | indent
tar -xvf "$GEOIP_CACHE_DIR/$GEOLITE2_COUNTRY_TARBALL_FILENAME" --directory "$BUILD_DIST_SHARE_DIR" --no-anchored --strip-components=1 "$GEOLITE2_COUNTRY_FILENAME"

echo "BUILD_DIST_SHARE_DIR: $BUILD_DIST_SHARE_DIR" | indent

echo $BUILD_DIST_SHARE_DIR
ls -l $BUILD_DIST_SHARE_DIR

echo "Set environment variables: GEOIP_GEOLITE2_PATH, GEOIP_GEOLITE2_CITY_FILENAME, GEOIP_GEOLITE2_COUNTRY_FILENAME" | indent

mkdir -p $BUILD_DIR/.profile.d
cat <<EOF >$BUILD_PACK_PATH/export
export GEOIP_GEOLITE2_PATH="\$HOME/.geoip/share/"
export GEOIP_GEOLITE2_CITY_FILENAME="$GEOLITE2_CITY_FILENAME"
export GEOIP_GEOLITE2_COUNTRY_FILENAME="$GEOLITE2_COUNTRY_FILENAME"
EOF
